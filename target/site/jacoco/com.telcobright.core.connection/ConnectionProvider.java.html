<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConnectionProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Generic Sharding-Aware Repository Framework</a> &gt; <a href="index.source.html" class="el_package">com.telcobright.core.connection</a> &gt; <span class="el_source">ConnectionProvider.java</span></div><h1>ConnectionProvider.java</h1><pre class="source lang-java linenums">package com.telcobright.core.connection;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.concurrent.locks.ReadWriteLock;
import java.util.concurrent.locks.ReentrantReadWriteLock;
import java.util.logging.Logger;

/**
 * Connection provider using plain JDBC with maintenance locking mechanism.
 * During maintenance operations, all CRUD operations are blocked.
 */
public class ConnectionProvider {
<span class="nc" id="L15">    private static final Logger LOGGER = Logger.getLogger(ConnectionProvider.class.getName());</span>
    
    private final String jdbcUrl;
    private final String username;
    private final String password;
    
    // Read-write lock for maintenance operations
    // Read lock: Normal CRUD operations can proceed concurrently
    // Write lock: Maintenance operations have exclusive access
<span class="nc" id="L24">    private final ReadWriteLock maintenanceLock = new ReentrantReadWriteLock(true);</span>
<span class="nc" id="L25">    private volatile boolean maintenanceInProgress = false;</span>
<span class="nc" id="L26">    private volatile String maintenanceReason = &quot;&quot;;</span>
    
    /**
     * Create a new ConnectionProvider
     */
<span class="nc" id="L31">    public ConnectionProvider(String host, int port, String database, String username, String password) {</span>
<span class="nc" id="L32">        this.username = username;</span>
<span class="nc" id="L33">        this.password = password;</span>
        
        // Build JDBC URL with timezone settings to prevent LocalDateTime conversion issues
<span class="nc" id="L36">        this.jdbcUrl = String.format(</span>
            &quot;jdbc:mysql://%s:%d/%s?useSSL=false&amp;serverTimezone=UTC&amp;useLegacyDatetimeCode=false&amp;preserveInstants=true&quot;,
<span class="nc" id="L38">            host, port, database</span>
        );
        
        // Load MySQL driver
        try {
<span class="nc" id="L43">            Class.forName(&quot;com.mysql.cj.jdbc.Driver&quot;);</span>
<span class="nc" id="L44">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L45">            throw new RuntimeException(&quot;MySQL JDBC driver not found&quot;, e);</span>
<span class="nc" id="L46">        }</span>
        
<span class="nc" id="L48">        LOGGER.info(&quot;ConnectionProvider initialized for: &quot; + jdbcUrl);</span>
<span class="nc" id="L49">    }</span>
    
    /**
     * Get a connection for normal CRUD operations.
     * This will block if maintenance is in progress.
     * 
     * @return A new database connection
     * @throws SQLException if connection cannot be established
     * @throws MaintenanceInProgressException if maintenance is actively running
     */
    public Connection getConnection() throws SQLException {
        // Try to acquire read lock (will block if maintenance has write lock)
<span class="nc" id="L61">        maintenanceLock.readLock().lock();</span>
        try {
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (maintenanceInProgress) {</span>
<span class="nc" id="L64">                throw new MaintenanceInProgressException(</span>
                    &quot;Database connections are blocked for maintenance: &quot; + maintenanceReason
                );
            }
            
<span class="nc" id="L69">            return createConnection();</span>
        } finally {
<span class="nc" id="L71">            maintenanceLock.readLock().unlock();</span>
        }
    }
    
    /**
     * Get a connection for maintenance operations.
     * This will acquire exclusive access and block all other operations.
     * 
     * @param reason Description of the maintenance operation
     * @return A maintenance connection holder that must be closed to release the lock
     */
    public MaintenanceConnection getMaintenanceConnection(String reason) throws SQLException {
<span class="nc" id="L83">        LOGGER.info(&quot;Acquiring maintenance lock for: &quot; + reason);</span>
        
        // Acquire write lock (will wait for all read locks to be released)
<span class="nc" id="L86">        maintenanceLock.writeLock().lock();</span>
<span class="nc" id="L87">        maintenanceInProgress = true;</span>
<span class="nc" id="L88">        maintenanceReason = reason;</span>
        
        try {
<span class="nc" id="L91">            Connection conn = createConnection();</span>
<span class="nc" id="L92">            return new MaintenanceConnection(conn, this);</span>
<span class="nc" id="L93">        } catch (SQLException e) {</span>
            // Release lock if connection fails
<span class="nc" id="L95">            releaseMaintenanceLock();</span>
<span class="nc" id="L96">            throw e;</span>
        }
    }
    
    /**
     * Create a new JDBC connection
     */
    private Connection createConnection() throws SQLException {
<span class="nc" id="L104">        return DriverManager.getConnection(jdbcUrl, username, password);</span>
    }
    
    /**
     * Release the maintenance lock (called by MaintenanceConnection.close())
     */
    void releaseMaintenanceLock() {
<span class="nc" id="L111">        maintenanceInProgress = false;</span>
<span class="nc" id="L112">        maintenanceReason = &quot;&quot;;</span>
<span class="nc" id="L113">        maintenanceLock.writeLock().unlock();</span>
<span class="nc" id="L114">        LOGGER.info(&quot;Maintenance lock released&quot;);</span>
<span class="nc" id="L115">    }</span>
    
    /**
     * Check if maintenance is currently in progress
     */
    public boolean isMaintenanceInProgress() {
<span class="nc" id="L121">        return maintenanceInProgress;</span>
    }
    
    /**
     * Get the reason for current maintenance (if any)
     */
    public String getMaintenanceReason() {
<span class="nc" id="L128">        return maintenanceReason;</span>
    }
    
    /**
     * Shutdown the connection provider
     */
    public void shutdown() {
<span class="nc" id="L135">        LOGGER.info(&quot;ConnectionProvider shutdown&quot;);</span>
<span class="nc" id="L136">    }</span>
    
    /**
     * Builder for ConnectionProvider
     */
<span class="nc" id="L141">    public static class Builder {</span>
<span class="nc" id="L142">        private String host = &quot;localhost&quot;;</span>
<span class="nc" id="L143">        private int port = 3306;</span>
        private String database;
        private String username;
        private String password;
        
        public Builder host(String host) {
<span class="nc" id="L149">            this.host = host;</span>
<span class="nc" id="L150">            return this;</span>
        }
        
        public Builder port(int port) {
<span class="nc" id="L154">            this.port = port;</span>
<span class="nc" id="L155">            return this;</span>
        }
        
        public Builder database(String database) {
<span class="nc" id="L159">            this.database = database;</span>
<span class="nc" id="L160">            return this;</span>
        }
        
        public Builder username(String username) {
<span class="nc" id="L164">            this.username = username;</span>
<span class="nc" id="L165">            return this;</span>
        }
        
        public Builder password(String password) {
<span class="nc" id="L169">            this.password = password;</span>
<span class="nc" id="L170">            return this;</span>
        }
        
        public ConnectionProvider build() {
<span class="nc bnc" id="L174" title="All 6 branches missed.">            if (database == null || username == null || password == null) {</span>
<span class="nc" id="L175">                throw new IllegalArgumentException(&quot;Database, username, and password are required&quot;);</span>
            }
<span class="nc" id="L177">            return new ConnectionProvider(host, port, database, username, password);</span>
        }
    }
    
    /**
     * Wrapper for maintenance connections that ensures lock is released
     */
    public static class MaintenanceConnection implements AutoCloseable {
        private final Connection connection;
        private final ConnectionProvider provider;
<span class="nc" id="L187">        private boolean closed = false;</span>
        
<span class="nc" id="L189">        MaintenanceConnection(Connection connection, ConnectionProvider provider) {</span>
<span class="nc" id="L190">            this.connection = connection;</span>
<span class="nc" id="L191">            this.provider = provider;</span>
<span class="nc" id="L192">        }</span>
        
        public Connection getConnection() {
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (closed) {</span>
<span class="nc" id="L196">                throw new IllegalStateException(&quot;Maintenance connection is closed&quot;);</span>
            }
<span class="nc" id="L198">            return connection;</span>
        }
        
        @Override
        public void close() {
<span class="nc bnc" id="L203" title="All 2 branches missed.">            if (!closed) {</span>
<span class="nc" id="L204">                closed = true;</span>
                try {
<span class="nc" id="L206">                    connection.close();</span>
<span class="nc" id="L207">                } catch (SQLException e) {</span>
<span class="nc" id="L208">                    LOGGER.warning(&quot;Error closing maintenance connection: &quot; + e.getMessage());</span>
                } finally {
<span class="nc" id="L210">                    provider.releaseMaintenanceLock();</span>
                }
            }
<span class="nc" id="L213">        }</span>
    }
    
    /**
     * Exception thrown when trying to get a connection during maintenance
     */
    public static class MaintenanceInProgressException extends SQLException {
        public MaintenanceInProgressException(String message) {
<span class="nc" id="L221">            super(message);</span>
<span class="nc" id="L222">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>