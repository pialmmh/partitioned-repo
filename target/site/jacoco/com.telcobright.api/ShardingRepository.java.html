<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShardingRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Generic Sharding-Aware Repository Framework</a> &gt; <a href="index.source.html" class="el_package">com.telcobright.api</a> &gt; <span class="el_source">ShardingRepository.java</span></div><h1>ShardingRepository.java</h1><pre class="source lang-java linenums">package com.telcobright.api;

import com.telcobright.core.entity.ShardingEntity;
import com.telcobright.core.pagination.Page;
import com.telcobright.core.pagination.PageRequest;

import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.List;

/**
 * Common interface for sharding-aware repositories
 *
 * Enforces that all entities used with this repository must implement ShardingEntity,
 * which guarantees the presence of required getId/setId and partition column accessors.
 *
 * All IDs are String type (externally generated - NO AUTO_INCREMENT).
 * Partition columns can be any Comparable type (LocalDateTime, Long, String, etc.)
 *
 * @param &lt;T&gt; Entity type that must implement ShardingEntity
 * @param &lt;P&gt; Partition column value type (must be Comparable)
 */
public interface ShardingRepository&lt;T extends ShardingEntity&lt;P&gt;, P extends Comparable&lt;? super P&gt;&gt; {
    
    /**
     * Insert a single entity
     */
    void insert(T entity) throws SQLException;
    
    /**
     * Insert multiple entities with batch optimization
     */
    void insertMultiple(List&lt;T&gt; entities) throws SQLException;
    
    /**
     * Find all entities within a partition value range
     */
    List&lt;T&gt; findAllByPartitionRange(P startValue, P endValue) throws SQLException;

    /**
     * Find all entities within a date range (backward compatibility)
     * @deprecated Use findAllByPartitionRange for generic support
     */
    @Deprecated
    default List&lt;T&gt; findAllByDateRange(LocalDateTime startDate, LocalDateTime endDate) throws SQLException {
        try {
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L48">            P start = (P) startDate;</span>
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L50">            P end = (P) endDate;</span>
<span class="nc" id="L51">            return findAllByPartitionRange(start, end);</span>
<span class="nc" id="L52">        } catch (ClassCastException e) {</span>
<span class="nc" id="L53">            throw new UnsupportedOperationException(&quot;This repository does not use LocalDateTime for partitioning&quot;, e);</span>
        }
    }
    
    /**
     * Find entity by primary key
     */
    T findById(String id) throws SQLException;
    
    /**
     * Find first entity within a partition value range
     */
    T findByIdAndPartitionRange(String id, P startValue, P endValue) throws SQLException;

    /**
     * Find first entity within a date range (backward compatibility)
     * @deprecated Use findByIdAndPartitionRange for generic support
     */
    @Deprecated
    default T findByIdAndDateRange(LocalDateTime startDate, LocalDateTime endDate) throws SQLException {
        try {
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L75">            P start = (P) startDate;</span>
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L77">            P end = (P) endDate;</span>
<span class="nc" id="L78">            return findByIdAndPartitionRange(null, start, end);</span>
<span class="nc" id="L79">        } catch (ClassCastException e) {</span>
<span class="nc" id="L80">            throw new UnsupportedOperationException(&quot;This repository does not use LocalDateTime for partitioning&quot;, e);</span>
        }
    }
    
    /**
     * Find all entities with specific IDs within a partition value range
     */
    List&lt;T&gt; findAllByIdsAndPartitionRange(List&lt;String&gt; ids, P startValue, P endValue) throws SQLException;

    /**
     * Find all entities with specific IDs within a date range (backward compatibility)
     * @deprecated Use findAllByIdsAndPartitionRange for generic support
     */
    @Deprecated
    default List&lt;T&gt; findAllByIdsAndDateRange(List&lt;String&gt; ids, LocalDateTime startDate, LocalDateTime endDate) throws SQLException {
        try {
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L97">            P start = (P) startDate;</span>
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L99">            P end = (P) endDate;</span>
<span class="nc" id="L100">            return findAllByIdsAndPartitionRange(ids, start, end);</span>
<span class="nc" id="L101">        } catch (ClassCastException e) {</span>
<span class="nc" id="L102">            throw new UnsupportedOperationException(&quot;This repository does not use LocalDateTime for partitioning&quot;, e);</span>
        }
    }
    
    /**
     * Find all entities before a specific partition value
     */
    List&lt;T&gt; findAllBeforePartitionValue(P beforeValue) throws SQLException;

    /**
     * Find all entities before a specific date (backward compatibility)
     * @deprecated Use findAllBeforePartitionValue for generic support
     */
    @Deprecated
    default List&lt;T&gt; findAllBeforeDate(LocalDateTime beforeDate) throws SQLException {
        try {
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L119">            P before = (P) beforeDate;</span>
<span class="nc" id="L120">            return findAllBeforePartitionValue(before);</span>
<span class="nc" id="L121">        } catch (ClassCastException e) {</span>
<span class="nc" id="L122">            throw new UnsupportedOperationException(&quot;This repository does not use LocalDateTime for partitioning&quot;, e);</span>
        }
    }
    
    /**
     * Find all entities after a specific partition value
     */
    List&lt;T&gt; findAllAfterPartitionValue(P afterValue) throws SQLException;

    /**
     * Find all entities after a specific date (backward compatibility)
     * @deprecated Use findAllAfterPartitionValue for generic support
     */
    @Deprecated
    default List&lt;T&gt; findAllAfterDate(LocalDateTime afterDate) throws SQLException {
        try {
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L139">            P after = (P) afterDate;</span>
<span class="nc" id="L140">            return findAllAfterPartitionValue(after);</span>
<span class="nc" id="L141">        } catch (ClassCastException e) {</span>
<span class="nc" id="L142">            throw new UnsupportedOperationException(&quot;This repository does not use LocalDateTime for partitioning&quot;, e);</span>
        }
    }
    
    /**
     * Update entity by primary key
     */
    void updateById(String id, T entity) throws SQLException;
    
    /**
     * Update entity by primary key within a specific partition value range
     */
    void updateByIdAndPartitionRange(String id, T entity, P startValue, P endValue) throws SQLException;

    /**
     * Update entity by primary key within a specific date range (backward compatibility)
     * @deprecated Use updateByIdAndPartitionRange for generic support
     */
    @Deprecated
    default void updateByIdAndDateRange(String id, T entity, LocalDateTime startDate, LocalDateTime endDate) throws SQLException {
        try {
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L164">            P start = (P) startDate;</span>
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L166">            P end = (P) endDate;</span>
<span class="nc" id="L167">            updateByIdAndPartitionRange(id, entity, start, end);</span>
<span class="nc" id="L168">        } catch (ClassCastException e) {</span>
<span class="nc" id="L169">            throw new UnsupportedOperationException(&quot;This repository does not use LocalDateTime for partitioning&quot;, e);</span>
<span class="nc" id="L170">        }</span>
<span class="nc" id="L171">    }</span>
    
    /**
     * Find one entity with ID greater than the specified ID.
     * For single partitioned table: Scans full table across all partitions.
     * For multi-table: Scans all tables chronologically to find the first entity with ID &gt; specified ID.
     * Useful for cursor-based iteration and finding next record.
     * 
     * @param id The ID to search greater than
     * @return The first entity found with ID greater than specified ID, or null if none found
     */
    T findOneByIdGreaterThan(String id) throws SQLException;
    
    /**
     * Find batch of entities with ID greater than the specified ID.
     * For single partitioned table: Executes single query with LIMIT across all partitions.
     * For multi-table: Iterates tables chronologically, accumulating results until batchSize is reached.
     * Useful for cursor-based pagination and batch processing.
     *
     * @param id The ID to search greater than
     * @param batchSize Maximum number of entities to return
     * @return List of entities with ID greater than specified ID, up to batchSize
     */
    List&lt;T&gt; findBatchByIdGreaterThan(String id, int batchSize) throws SQLException;

    /**
     * Delete entity by primary key
     */
    void deleteById(String id) throws SQLException;

    /**
     * Delete entity by primary key within a specific partition value range
     */
    void deleteByIdAndPartitionRange(String id, P startValue, P endValue) throws SQLException;

    /**
     * Delete entity by primary key within a specific date range (backward compatibility)
     * @deprecated Use deleteByIdAndPartitionRange for generic support
     */
    @Deprecated
    default void deleteByIdAndDateRange(String id, LocalDateTime startDate, LocalDateTime endDate) throws SQLException {
        try {
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L214">            P start = (P) startDate;</span>
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L216">            P end = (P) endDate;</span>
<span class="nc" id="L217">            deleteByIdAndPartitionRange(id, start, end);</span>
<span class="nc" id="L218">        } catch (ClassCastException e) {</span>
<span class="nc" id="L219">            throw new UnsupportedOperationException(&quot;This repository does not use LocalDateTime for partitioning&quot;, e);</span>
<span class="nc" id="L220">        }</span>
<span class="nc" id="L221">    }</span>

    /**
     * Delete all entities within a partition value range
     */
    void deleteAllByPartitionRange(P startValue, P endValue) throws SQLException;

    /**
     * Delete all entities within a date range (backward compatibility)
     * @deprecated Use deleteAllByPartitionRange for generic support
     */
    @Deprecated
    default void deleteAllByDateRange(LocalDateTime startDate, LocalDateTime endDate) throws SQLException {
        try {
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L236">            P start = (P) startDate;</span>
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L238">            P end = (P) endDate;</span>
<span class="nc" id="L239">            deleteAllByPartitionRange(start, end);</span>
<span class="nc" id="L240">        } catch (ClassCastException e) {</span>
<span class="nc" id="L241">            throw new UnsupportedOperationException(&quot;This repository does not use LocalDateTime for partitioning&quot;, e);</span>
<span class="nc" id="L242">        }</span>
<span class="nc" id="L243">    }</span>

    /**
     * Shutdown the repository and release resources
     */
    void shutdown();
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>