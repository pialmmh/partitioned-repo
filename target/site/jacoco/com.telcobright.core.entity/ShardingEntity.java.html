<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShardingEntity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Generic Sharding-Aware Repository Framework</a> &gt; <a href="index.source.html" class="el_package">com.telcobright.core.entity</a> &gt; <span class="el_source">ShardingEntity.java</span></div><h1>ShardingEntity.java</h1><pre class="source lang-java linenums">package com.telcobright.core.entity;

import com.telcobright.core.annotation.Column;
import com.telcobright.core.annotation.ShardingKey;
import java.lang.reflect.Field;
import java.time.LocalDateTime;

/**
 * Base interface for all entities used with ShardingRepository.
 * Supports generic partition column types for flexible range-based partitioning.
 *
 * Requirements:
 * 1. All IDs must be String type (externally generated - NO AUTO_INCREMENT)
 * 2. All entities must have a partition column annotated with @ShardingKey
 * 3. Partition column type must be Comparable for range queries
 * 4. No composite key support - single String ID only
 *
 * Implementation notes:
 * - ID field must be annotated with @Id(autoGenerated = false)
 * - Partition field must be annotated with @ShardingKey and @Column
 * - Use external ID generators: UUID, NanoID, ULID, etc.
 *
 * Example:
 * &lt;pre&gt;
 * @Table(name = &quot;calls&quot;)
 * public class Call implements ShardingEntity&amp;lt;LocalDateTime&amp;gt; {
 *     @Id(autoGenerated = false)
 *     @Column(name = &quot;call_id&quot;)
 *     private String id;
 *
 *     @ShardingKey
 *     @Column(name = &quot;start_time&quot;)
 *     private LocalDateTime startTime;
 *
 *     // implement interface methods...
 * }
 * &lt;/pre&gt;
 *
 * @param &lt;T&gt; The type of the partition column value (must be Comparable)
 */
public interface ShardingEntity&lt;T extends Comparable&lt;? super T&gt;&gt; {
    /**
     * Get the entity's unique identifier.
     * Must be externally generated (UUID, NanoID, ULID, etc.)
     *
     * @return the entity ID as String
     */
    String getId();

    /**
     * Set the entity's unique identifier.
     * IDs must be generated externally before insertion.
     *
     * @param id the entity ID as String
     */
    void setId(String id);

    /**
     * Get the partition column value used for range-based partitioning.
     * This value is critical for partition pruning and query routing.
     *
     * @return the partition column value
     */
    T getPartitionColValue();

    /**
     * Set the partition column value used for range-based partitioning.
     *
     * @param value the partition column value
     */
    void setPartitionColValue(T value);

    /**
     * Get the partition column name from the field annotated with @ShardingKey.
     * This extracts the column name from the @Column annotation on the @ShardingKey field.
     *
     * @return the database column name (e.g., &quot;created_at&quot;, &quot;start_time&quot;, &quot;amount&quot;)
     */
    default String getPartitionColName() {
        // Find field with @ShardingKey annotation
<span class="nc bnc" id="L81" title="All 2 branches missed.">        for (Field field : this.getClass().getDeclaredFields()) {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">            if (field.isAnnotationPresent(ShardingKey.class)) {</span>
                // Get column name from @Column annotation
<span class="nc" id="L84">                Column column = field.getAnnotation(Column.class);</span>
<span class="nc bnc" id="L85" title="All 6 branches missed.">                if (column != null &amp;&amp; column.name() != null &amp;&amp; !column.name().isEmpty()) {</span>
<span class="nc" id="L86">                    return column.name();</span>
                }
                // Fallback to field name if no @Column
<span class="nc" id="L89">                return field.getName();</span>
            }
        }
<span class="nc" id="L92">        throw new IllegalStateException(&quot;No field with @ShardingKey annotation found in &quot; + this.getClass().getName());</span>
    }

    /**
     * Get the datetime value used for partitioning.
     * This method is kept for backward compatibility with existing code.
     *
     * @return the partitioning datetime
     * @deprecated Use getPartitionColValue() instead for generic support
     */
    @Deprecated
    default LocalDateTime getCreatedAt() {
<span class="nc" id="L104">        Object value = getPartitionColValue();</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (value instanceof LocalDateTime) {</span>
<span class="nc" id="L106">            return (LocalDateTime) value;</span>
        }
<span class="nc" id="L108">        throw new UnsupportedOperationException(&quot;This entity does not use LocalDateTime for partitioning&quot;);</span>
    }

    /**
     * Set the datetime value used for partitioning.
     * This method is kept for backward compatibility with existing code.
     *
     * @param createdAt the partitioning datetime
     * @deprecated Use setPartitionColValue() instead for generic support
     */
    @Deprecated
    @SuppressWarnings(&quot;unchecked&quot;)
    default void setCreatedAt(LocalDateTime createdAt) {
        try {
<span class="nc" id="L122">            setPartitionColValue((T) createdAt);</span>
<span class="nc" id="L123">        } catch (ClassCastException e) {</span>
<span class="nc" id="L124">            throw new UnsupportedOperationException(&quot;This entity does not use LocalDateTime for partitioning&quot;);</span>
<span class="nc" id="L125">        }</span>
<span class="nc" id="L126">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>