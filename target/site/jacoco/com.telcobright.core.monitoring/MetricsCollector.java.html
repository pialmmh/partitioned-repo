<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MetricsCollector.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Generic Sharding-Aware Repository Framework</a> &gt; <a href="index.source.html" class="el_package">com.telcobright.core.monitoring</a> &gt; <span class="el_source">MetricsCollector.java</span></div><h1>MetricsCollector.java</h1><pre class="source lang-java linenums">package com.telcobright.core.monitoring;

import com.telcobright.core.connection.ConnectionProvider;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * Collects metrics from database for repository monitoring
 */
public class MetricsCollector {
    
    private final ConnectionProvider connectionProvider;
    private final String databaseName;
    
<span class="nc" id="L19">    public MetricsCollector(ConnectionProvider connectionProvider, String databaseName) {</span>
<span class="nc" id="L20">        this.connectionProvider = connectionProvider;</span>
<span class="nc" id="L21">        this.databaseName = databaseName;</span>
<span class="nc" id="L22">    }</span>
    
    /**
     * Count number of partitions for a partitioned table
     */
    public int countPartitions(String tableName) {
<span class="nc" id="L28">        String sql = &quot;SELECT COUNT(*) FROM INFORMATION_SCHEMA.PARTITIONS &quot; +</span>
                    &quot;WHERE TABLE_SCHEMA = ? AND TABLE_NAME = ? AND PARTITION_NAME IS NOT NULL&quot;;
        
<span class="nc" id="L31">        try (Connection conn = connectionProvider.getConnection();</span>
<span class="nc" id="L32">             PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
            
<span class="nc" id="L34">            stmt.setString(1, databaseName);</span>
<span class="nc" id="L35">            stmt.setString(2, tableName);</span>
            
<span class="nc" id="L37">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L39">                    return rs.getInt(1);</span>
                }
<span class="nc bnc" id="L41" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L42" title="All 4 branches missed.">        } catch (SQLException e) {</span>
            // Log error and return 0
<span class="nc" id="L44">            System.err.printf(&quot;Error counting partitions for table %s: %s%n&quot;, tableName, e.getMessage());</span>
<span class="nc" id="L45">        }</span>
        
<span class="nc" id="L47">        return 0;</span>
    }
    
    /**
     * Get list of partition names for a partitioned table
     */
    public List&lt;String&gt; getPartitionNames(String tableName) {
<span class="nc" id="L54">        List&lt;String&gt; partitions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L55">        String sql = &quot;SELECT PARTITION_NAME FROM INFORMATION_SCHEMA.PARTITIONS &quot; +</span>
                    &quot;WHERE TABLE_SCHEMA = ? AND TABLE_NAME = ? AND PARTITION_NAME IS NOT NULL &quot; +
                    &quot;ORDER BY PARTITION_NAME&quot;;
        
<span class="nc" id="L59">        try (Connection conn = connectionProvider.getConnection();</span>
<span class="nc" id="L60">             PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
            
<span class="nc" id="L62">            stmt.setString(1, databaseName);</span>
<span class="nc" id="L63">            stmt.setString(2, tableName);</span>
            
<span class="nc" id="L65">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L67">                    partitions.add(rs.getString(&quot;PARTITION_NAME&quot;));</span>
                }
            }
<span class="nc" id="L70">        } catch (SQLException e) {</span>
<span class="nc" id="L71">            System.err.printf(&quot;Error getting partition names for table %s: %s%n&quot;, tableName, e.getMessage());</span>
<span class="nc" id="L72">        }</span>
        
<span class="nc" id="L74">        return partitions;</span>
    }
    
    /**
     * Count number of tables with a specific prefix
     */
    public int countPrefixedTables(String tablePrefix) {
<span class="nc" id="L81">        String sql = &quot;SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES &quot; +</span>
                    &quot;WHERE TABLE_SCHEMA = ? AND TABLE_NAME LIKE ?&quot;;
        
<span class="nc" id="L84">        try (Connection conn = connectionProvider.getConnection();</span>
<span class="nc" id="L85">             PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
            
<span class="nc" id="L87">            stmt.setString(1, databaseName);</span>
<span class="nc" id="L88">            stmt.setString(2, tablePrefix + &quot;%&quot;);</span>
            
<span class="nc" id="L90">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L92">                    return rs.getInt(1);</span>
                }
<span class="nc bnc" id="L94" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L95" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L96">            System.err.printf(&quot;Error counting prefixed tables for prefix %s: %s%n&quot;, tablePrefix, e.getMessage());</span>
<span class="nc" id="L97">        }</span>
        
<span class="nc" id="L99">        return 0;</span>
    }
    
    /**
     * Get list of table names with a specific prefix
     */
    public List&lt;String&gt; getPrefixedTableNames(String tablePrefix) {
<span class="nc" id="L106">        List&lt;String&gt; tables = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L107">        String sql = &quot;SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES &quot; +</span>
                    &quot;WHERE TABLE_SCHEMA = ? AND TABLE_NAME LIKE ? &quot; +
                    &quot;ORDER BY TABLE_NAME&quot;;
        
<span class="nc" id="L111">        try (Connection conn = connectionProvider.getConnection();</span>
<span class="nc" id="L112">             PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
            
<span class="nc" id="L114">            stmt.setString(1, databaseName);</span>
<span class="nc" id="L115">            stmt.setString(2, tablePrefix + &quot;%&quot;);</span>
            
<span class="nc" id="L117">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L119">                    tables.add(rs.getString(&quot;TABLE_NAME&quot;));</span>
                }
            }
<span class="nc" id="L122">        } catch (SQLException e) {</span>
<span class="nc" id="L123">            System.err.printf(&quot;Error getting prefixed table names for prefix %s: %s%n&quot;, tablePrefix, e.getMessage());</span>
<span class="nc" id="L124">        }</span>
        
<span class="nc" id="L126">        return tables;</span>
    }
    
    /**
     * Get CREATE TABLE statement to analyze partitions
     */
    public String getCreateTableStatement(String tableName) {
<span class="nc" id="L133">        String sql = &quot;SHOW CREATE TABLE &quot; + tableName;</span>
        
<span class="nc" id="L135">        try (Connection conn = connectionProvider.getConnection();</span>
<span class="nc" id="L136">             PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
            
<span class="nc" id="L138">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc" id="L140">                    return rs.getString(2); // Second column contains CREATE TABLE statement</span>
                }
<span class="nc bnc" id="L142" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L144">            System.err.printf(&quot;Error getting CREATE TABLE for table %s: %s%n&quot;, tableName, e.getMessage());</span>
<span class="nc" id="L145">        }</span>
        
<span class="nc" id="L147">        return null;</span>
    }
    
    /**
     * Check if table exists
     */
    public boolean tableExists(String tableName) {
<span class="nc" id="L154">        String sql = &quot;SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES &quot; +</span>
                    &quot;WHERE TABLE_SCHEMA = ? AND TABLE_NAME = ?&quot;;
        
<span class="nc" id="L157">        try (Connection conn = connectionProvider.getConnection();</span>
<span class="nc" id="L158">             PreparedStatement stmt = conn.prepareStatement(sql)) {</span>
            
<span class="nc" id="L160">            stmt.setString(1, databaseName);</span>
<span class="nc" id="L161">            stmt.setString(2, tableName);</span>
            
<span class="nc" id="L163">            try (ResultSet rs = stmt.executeQuery()) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                if (rs.next()) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                    return rs.getInt(1) &gt; 0;</span>
                }
<span class="nc bnc" id="L167" title="All 2 branches missed.">            }</span>
<span class="nc bnc" id="L168" title="All 4 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L169">            System.err.printf(&quot;Error checking if table %s exists: %s%n&quot;, tableName, e.getMessage());</span>
<span class="nc" id="L170">        }</span>
        
<span class="nc" id="L172">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>