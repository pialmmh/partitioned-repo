<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SmsMultiTableConsoleExample.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Generic Sharding-Aware Repository Framework</a> &gt; <a href="index.source.html" class="el_package">com.telcobright.examples.demo</a> &gt; <span class="el_source">SmsMultiTableConsoleExample.java</span></div><h1>SmsMultiTableConsoleExample.java</h1><pre class="source lang-java linenums">package com.telcobright.examples.demo;

import com.telcobright.examples.entity.SmsEntity;
import com.telcobright.core.repository.SplitVerseRepository;
import com.telcobright.splitverse.config.ShardConfig;
import com.telcobright.core.monitoring.MonitoringConfig;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;

/**
 * Example demonstrating SMS multi-table repository with console monitoring
 * 
 * Features shown:
 * - Multi-table repository with hourly partitioned daily tables
 * - Console monitoring output with formatted metrics
 * - High-volume SMS message handling
 * - Automatic table creation and maintenance
 * - 7-day default retention period
 */
<span class="nc" id="L23">public class SmsMultiTableConsoleExample {</span>
    
    private static SmsEntity createDeliveredSms(String userId, String phoneNumber, String message, String status, 
                                              LocalDateTime createdAt, LocalDateTime deliveredAt, 
                                              BigDecimal cost, String provider) {
<span class="nc" id="L28">        SmsEntity sms = new SmsEntity(userId, phoneNumber, message, status, createdAt, cost, provider);</span>
<span class="nc" id="L29">        sms.setDeliveredAt(deliveredAt);</span>
<span class="nc" id="L30">        return sms;</span>
    }
    
    public static void main(String[] args) {
<span class="nc" id="L34">        System.out.println(&quot;=== SMS Multi-Table Repository with Console Monitoring ===\n&quot;);</span>
        
        // Configure console monitoring
<span class="nc" id="L37">        MonitoringConfig consoleMonitoring = new MonitoringConfig.Builder()</span>
<span class="nc" id="L38">            .deliveryMethod(MonitoringConfig.DeliveryMethod.CONSOLE_ONLY)</span>
<span class="nc" id="L39">            .metricFormat(MonitoringConfig.MetricFormat.FORMATTED_TEXT)</span>
<span class="nc" id="L40">            .reportingIntervalSeconds(60)  // Report every minute for demo</span>
<span class="nc" id="L41">            .serviceName(&quot;sms-service&quot;)</span>
<span class="nc" id="L42">            .instanceId(&quot;sms-server-01&quot;)</span>
<span class="nc" id="L43">            .build();</span>
        
        // Create SMS repository with console monitoring using Split-Verse
<span class="nc" id="L46">        SplitVerseRepository&lt;SmsEntity, LocalDateTime&gt; smsRepo = null;</span>
        try {
            // Configure shard
<span class="nc" id="L49">            ShardConfig shardConfig = ShardConfig.builder()</span>
<span class="nc" id="L50">                .shardId(&quot;primary&quot;)</span>
<span class="nc" id="L51">                .host(&quot;127.0.0.1&quot;)</span>
<span class="nc" id="L52">                .port(3306)</span>
<span class="nc" id="L53">                .database(&quot;messaging&quot;)</span>
<span class="nc" id="L54">                .username(&quot;root&quot;)</span>
<span class="nc" id="L55">                .password(&quot;123456&quot;)</span>
<span class="nc" id="L56">                .connectionPoolSize(10)</span>
<span class="nc" id="L57">                .enabled(true)</span>
<span class="nc" id="L58">                .build();</span>
            
<span class="nc" id="L60">            smsRepo = SplitVerseRepository.&lt;SmsEntity, LocalDateTime&gt;builder()</span>
<span class="nc" id="L61">                .withSingleShard(shardConfig)</span>
<span class="nc" id="L62">                .withEntityClass(SmsEntity.class)</span>
<span class="nc" id="L63">                .build();</span>
            
<span class="nc" id="L65">            System.out.println(&quot;‚úÖ SMS Repository created successfully&quot;);</span>
<span class="nc" id="L66">            System.out.println(&quot;   - Table Structure: Daily tables with 24 hourly partitions each&quot;);</span>
<span class="nc" id="L67">            System.out.println(&quot;   - Total Partitions: 15 tables √ó 24 hours = 360 partitions&quot;);</span>
<span class="nc" id="L68">            System.out.println(&quot;   - Monitoring: Console output every 60 seconds\n&quot;);</span>
            
            // Insert sample SMS messages
<span class="nc" id="L71">            System.out.println(&quot;üì§ Inserting SMS messages...&quot;);</span>
            
<span class="nc" id="L73">            List&lt;SmsEntity&gt; sampleMessages = Arrays.asList(</span>
                new SmsEntity(&quot;user001&quot;, &quot;+1234567890&quot;, &quot;Welcome to our service!&quot;, &quot;SENT&quot;, 
<span class="nc" id="L75">                             LocalDateTime.now(), new BigDecimal(&quot;0.05&quot;), &quot;twilio&quot;),</span>
                new SmsEntity(&quot;user002&quot;, &quot;+1234567891&quot;, &quot;Your order has been shipped&quot;, &quot;SENT&quot;, 
<span class="nc" id="L77">                             LocalDateTime.now().minusMinutes(30), new BigDecimal(&quot;0.05&quot;), &quot;aws-sns&quot;),</span>
<span class="nc" id="L78">                createDeliveredSms(&quot;user003&quot;, &quot;+1234567892&quot;, &quot;Payment confirmation&quot;, &quot;DELIVERED&quot;, </span>
<span class="nc" id="L79">                             LocalDateTime.now().minusHours(2), LocalDateTime.now().minusMinutes(90), </span>
                             new BigDecimal(&quot;0.04&quot;), &quot;messagebird&quot;),
                new SmsEntity(&quot;user001&quot;, &quot;+1234567890&quot;, &quot;Account verification code: 123456&quot;, &quot;SENT&quot;, 
<span class="nc" id="L82">                             LocalDateTime.now().minusHours(6), new BigDecimal(&quot;0.06&quot;), &quot;twilio&quot;),</span>
                new SmsEntity(&quot;user004&quot;, &quot;+1234567893&quot;, &quot;Appointment reminder&quot;, &quot;FAILED&quot;, 
<span class="nc" id="L84">                             LocalDateTime.now().minusHours(12), new BigDecimal(&quot;0.05&quot;), &quot;plivo&quot;)</span>
            );
            
            // Insert messages individually to show auto-generation
<span class="nc bnc" id="L88" title="All 2 branches missed.">            for (int i = 0; i &lt; sampleMessages.size(); i++) {</span>
<span class="nc" id="L89">                smsRepo.insert(sampleMessages.get(i));</span>
<span class="nc" id="L90">                System.out.printf(&quot;   ‚úì Inserted SMS %d with auto-generated ID\n&quot;, i + 1);</span>
            }
            
            // Insert batch of messages
<span class="nc" id="L94">            List&lt;SmsEntity&gt; batchMessages = Arrays.asList(</span>
                new SmsEntity(&quot;user005&quot;, &quot;+1234567894&quot;, &quot;Flash sale alert!&quot;, &quot;SENT&quot;, 
<span class="nc" id="L96">                             LocalDateTime.now().minusDays(1), new BigDecimal(&quot;0.03&quot;), &quot;nexmo&quot;),</span>
<span class="nc" id="L97">                createDeliveredSms(&quot;user006&quot;, &quot;+1234567895&quot;, &quot;Password reset link&quot;, &quot;DELIVERED&quot;, </span>
<span class="nc" id="L98">                             LocalDateTime.now().minusDays(2), LocalDateTime.now().minusDays(2).plusMinutes(5), </span>
                             new BigDecimal(&quot;0.05&quot;), &quot;twilio&quot;)
            );
            
<span class="nc" id="L102">            smsRepo.insertMultiple(batchMessages);</span>
<span class="nc" id="L103">            System.out.println(&quot;   ‚úì Inserted batch of 2 SMS messages\n&quot;);</span>
            
            // Query operations to demonstrate functionality
<span class="nc" id="L106">            System.out.println(&quot;üîç Performing query operations...&quot;);</span>
            
            // Find messages from last 24 hours
<span class="nc" id="L109">            List&lt;SmsEntity&gt; recentMessages = smsRepo.findAllByDateRange(</span>
<span class="nc" id="L110">                LocalDateTime.now().minusDays(1), </span>
<span class="nc" id="L111">                LocalDateTime.now()</span>
            );
<span class="nc" id="L113">            System.out.printf(&quot;   Found %d messages in last 24 hours\n&quot;, recentMessages.size());</span>
            
            // Find a specific message by ID (demonstrates cross-table search)
<span class="nc bnc" id="L116" title="All 2 branches missed.">            if (!recentMessages.isEmpty()) {</span>
<span class="nc" id="L117">                SmsEntity firstMessage = recentMessages.get(0);</span>
<span class="nc" id="L118">                SmsEntity foundMessage = smsRepo.findById(firstMessage.getId());</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                if (foundMessage != null) {</span>
<span class="nc" id="L120">                    System.out.printf(&quot;   ‚úì Found message by ID: %d (Status: %s)\n&quot;, </span>
<span class="nc" id="L121">                                    foundMessage.getId(), foundMessage.getStatus());</span>
                }
            }
            
            // Update a message status
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (!recentMessages.isEmpty()) {</span>
<span class="nc" id="L127">                SmsEntity messageToUpdate = recentMessages.get(0);</span>
<span class="nc" id="L128">                SmsEntity updateData = new SmsEntity();</span>
<span class="nc" id="L129">                updateData.setStatus(&quot;DELIVERED&quot;);</span>
<span class="nc" id="L130">                updateData.setDeliveredAt(LocalDateTime.now());</span>
                
<span class="nc" id="L132">                smsRepo.updateById(messageToUpdate.getId(), updateData);</span>
<span class="nc" id="L133">                System.out.printf(&quot;   ‚úì Updated message ID %d to DELIVERED status\n&quot;, messageToUpdate.getId());</span>
            }
            
<span class="nc" id="L136">            System.out.println(&quot;\n‚è±Ô∏è  Waiting for monitoring output (60 seconds)...&quot;);</span>
<span class="nc" id="L137">            System.out.println(&quot;    Console monitoring will automatically display metrics&quot;);</span>
            
            // Keep the application running to see monitoring output
<span class="nc" id="L140">            Thread.sleep(70000); // 70 seconds to see at least one monitoring report</span>
            
<span class="nc" id="L142">        } catch (Exception e) {</span>
<span class="nc" id="L143">            System.err.println(&quot;‚ùå Error: &quot; + e.getMessage());</span>
<span class="nc" id="L144">            e.printStackTrace();</span>
        } finally {
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (smsRepo != null) {</span>
<span class="nc" id="L147">                System.out.println(&quot;\nüõë Shutting down SMS repository...&quot;);</span>
<span class="nc" id="L148">                smsRepo.shutdown();</span>
<span class="nc" id="L149">                System.out.println(&quot;   ‚úì Repository shut down gracefully&quot;);</span>
            }
        }
        
<span class="nc" id="L153">        System.out.println(&quot;\n=== SMS Multi-Table Example Complete ===&quot;);</span>
<span class="nc" id="L154">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>