# Test Specification: autoManagePartitions Configuration

## Feature Overview
The `autoManagePartitions` configuration parameter controls whether repositories automatically manage table/partition lifecycle or expect manual management.

## Test Objectives
Verify that repositories behave correctly based on the `autoManagePartitions` configuration setting.

## Test Scenarios

### 1. GenericPartitionedTableRepository Tests

#### Test 1.1: Auto-Management Enabled (Default)
**Given:** autoManagePartitions = true (default)
**When:** Repository is initialized
**Then:**
- Table and partitions are created automatically
- Retention period is enforced
- Old partitions are dropped automatically
- Scheduler runs for maintenance

#### Test 1.2: Auto-Management Disabled - Table Exists
**Given:**
- autoManagePartitions = false
- Table and partitions already exist in database
**When:** Repository is initialized
**Then:**
- Repository initializes successfully
- No new partitions are created
- Existing partitions are used
- No scheduler is started

#### Test 1.3: Auto-Management Disabled - Table Missing
**Given:**
- autoManagePartitions = false
- Table does NOT exist in database
**When:** Repository is initialized
**Then:**
- Repository initialization fails with RuntimeException
- Error message: "Table 'X' does not exist in database 'Y'. When autoManagePartitions=false, table and partitions must be created manually."

#### Test 1.4: Auto-Management Disabled - Operations
**Given:**
- autoManagePartitions = false
- Table exists with manually created partitions
**When:** CRUD operations are performed
**Then:**
- Insert/Update/Delete operations work normally
- No automatic partition creation
- No automatic partition dropping

### 2. GenericMultiTableRepository Tests

#### Test 2.1: Auto-Management Enabled (Default)
**Given:** autoManagePartitions = true
**When:** Repository is initialized
**Then:**
- Tables for retention period are created automatically
- Old tables are dropped based on retention
- New tables are created as needed

#### Test 2.2: Auto-Management Disabled - Tables Exist
**Given:**
- autoManagePartitions = false
- Tables with correct prefix exist
**When:** Repository is initialized
**Then:**
- Repository discovers existing tables
- Uses existing tables for operations
- No new tables created

#### Test 2.3: Auto-Management Disabled - No Tables
**Given:**
- autoManagePartitions = false
- No tables with matching prefix exist
**When:** Repository is initialized
**Then:**
- Repository initialization fails with RuntimeException
- Error message: "No existing tables found with prefix 'X' in database 'Y'. When autoManagePartitions=false, tables must be created manually before using the repository."

#### Test 2.4: Auto-Management Disabled - Partial Tables
**Given:**
- autoManagePartitions = false
- Some tables exist (not covering full date range)
**When:** Operations span missing table dates
**Then:**
- Operations on existing tables succeed
- Operations on missing tables fail with SQL errors
- No automatic table creation

### 3. Multi-Entity Repository Tests

#### Test 3.1: Mixed Configuration
**Given:**
- Entity A: autoManagePartitions = true
- Entity B: autoManagePartitions = false (table exists)
- Entity C: autoManagePartitions = false (table missing)
**When:** MultiEntityRepository is built
**Then:**
- Entity A repository initializes with auto-management
- Entity B repository uses existing table
- Entity C repository fails initialization

#### Test 3.2: All Manual Management
**Given:**
- All entities have autoManagePartitions = false
- All required tables exist
**When:** Repository operations are performed
**Then:**
- All operations use existing tables
- No automatic management occurs
- Performance is optimal (no management overhead)

### 4. Edge Cases

#### Test 4.1: Configuration Change
**Given:**
- Repository initially created with autoManagePartitions = true
- Tables/partitions were auto-created
**When:** New repository instance with autoManagePartitions = false
**Then:**
- Repository uses existing tables successfully
- No further automatic management

#### Test 4.2: Retention Period Ignored
**Given:**
- autoManagePartitions = false
- retentionDays = 7
- Tables older than 7 days exist
**When:** Repository operates
**Then:**
- Old tables are NOT dropped
- retentionDays setting is ignored

## Test Data Requirements

### Entities
```java
@Table(name = "test_events")
public class TestEvent implements ShardingEntity<LocalDateTime> {
    @Id(autoGenerated = false)
    private String id;

    @ShardingKey
    @Column(name = "event_time")
    private LocalDateTime eventTime;

    @Column(name = "event_data")
    private String data;
}
```

### Pre-created Tables (for manual management tests)
```sql
-- For GenericPartitionedTableRepository
CREATE TABLE test_events (
    id VARCHAR(255),
    event_time DATETIME,
    event_data VARCHAR(255),
    PRIMARY KEY (id, event_time)
) PARTITION BY RANGE (TO_DAYS(event_time)) (
    PARTITION p20250925 VALUES LESS THAN (TO_DAYS('2025-09-26')),
    PARTITION p20250926 VALUES LESS THAN (TO_DAYS('2025-09-27')),
    PARTITION p20250927 VALUES LESS THAN (TO_DAYS('2025-09-28'))
);

-- For GenericMultiTableRepository
CREATE TABLE test_events_20250925 (...);
CREATE TABLE test_events_20250926 (...);
CREATE TABLE test_events_20250927 (...);
```

## Success Criteria

1. **Fail-Fast Behavior**: Repositories with autoManagePartitions=false fail immediately with clear errors when tables don't exist
2. **No Silent Failures**: Missing tables/partitions are detected at initialization, not during operations
3. **Clear Error Messages**: All failure messages explicitly mention autoManagePartitions configuration
4. **Performance**: Manual management mode has no overhead from maintenance operations
5. **Backward Compatibility**: Default behavior (autoManagePartitions=true) remains unchanged

## Test Execution Strategy

1. **Setup Phase**:
   - Create test database
   - For manual tests, pre-create required tables

2. **Test Execution**:
   - Run each test scenario in isolation
   - Verify both positive and negative cases
   - Check error messages match expected text

3. **Cleanup Phase**:
   - Drop all test tables
   - Reset database state

## Expected Results Summary

| Repository Type | autoManagePartitions | Tables Exist | Expected Result |
|-----------------|---------------------|--------------|-----------------|
| Partitioned | true | N/A | Success - Creates tables |
| Partitioned | false | Yes | Success - Uses existing |
| Partitioned | false | No | Failure - Clear error |
| MultiTable | true | N/A | Success - Creates tables |
| MultiTable | false | Yes | Success - Uses existing |
| MultiTable | false | No | Failure - Clear error |